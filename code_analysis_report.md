# åŸºå‡†æ¨¡å‹ä»£ç åˆ†ææŠ¥å‘Š

## å®éªŒç»“æœæ€»ç»“

### æ•´ä½“è¡¨ç°

åœ¨æ‰€æœ‰9ä¸ªå®éªŒé…ç½®ä¸­ï¼ˆ3ä¸ªæ•°æ®é›† Ã— 3ä¸ªé¢„æµ‹æ­¥é•¿ï¼‰ï¼Œ**STAEformer åœ¨æ‰€æœ‰å®éªŒä¸­éƒ½æ˜¾è‘—ä¼˜äº STGCN**ï¼š

| æ•°æ®é›† | é¢„æµ‹æ­¥é•¿ | STAEformerä¼˜åŠ¿ |
|--------|----------|----------------|
| PEMS04 | 3/6/12æ­¥ | 12-22% (MAE) |
| PEMS08 | 3/6/12æ­¥ | 26-33% (MAE) |
| METR-LA | 3/6/12æ­¥ | 45-54% (MAE) |

**ç»Ÿè®¡**: STAEformeråœ¨9/9ä¸ªå®éªŒä¸­è·èƒœ (100%)

---

## ä»£ç å®ç°å·®å¼‚åˆ†æ

### 1. âš ï¸ è¯„ä¼°æŒ‡æ ‡è®¡ç®—å·®å¼‚ï¼ˆå…³é”®é—®é¢˜ï¼‰

#### STAEformerçš„Metricså®ç°

```python
# STAEformer/lib/metrics.py
def MAE(y_true, y_pred):
    with np.errstate(divide="ignore", invalid="ignore"):
        mask = np.not_equal(y_true, 0)  # åˆ›å»ºmaskï¼Œå¿½ç•¥y_true=0çš„ç‚¹
        mask = mask.astype(np.float32)
        mask /= np.mean(mask)           # å½’ä¸€åŒ–mask
        mae = np.abs(y_pred - y_true)
        mae = np.nan_to_num(mae * mask) # åªè®¡ç®—éé›¶ç‚¹çš„è¯¯å·®
        mae = np.mean(mae)
        return mae
```

**å…³é”®ç‰¹å¾**:
- ä½¿ç”¨`mask = np.not_equal(y_true, 0)`æ¥**å¿½ç•¥çœŸå®å€¼ä¸º0çš„æ‰€æœ‰ç‚¹**
- maskè¢«å½’ä¸€åŒ–: `mask /= np.mean(mask)`
- RMSE, MAPEä¹Ÿéƒ½ä½¿ç”¨ç›¸åŒçš„maskæœºåˆ¶

#### STGCNçš„Metricså®ç°

```python
# STGCN/train_pems04_3step.py (lines 229-234)
mae = np.mean(np.abs(y_true_denorm - y_pred_denorm))
rmse = np.sqrt(np.mean((y_true_denorm - y_pred_denorm) ** 2))

# MAPE (é¿å…é™¤0)
mask = y_true_denorm != 0
mape = np.mean(np.abs((y_true_denorm[mask] - y_pred_denorm[mask]) / y_true_denorm[mask])) * 100
```

**å…³é”®ç‰¹å¾**:
- MAEå’ŒRMSEä½¿ç”¨æ ‡å‡†è®¡ç®—ï¼Œ**åŒ…å«æ‰€æœ‰ç‚¹**
- åªæœ‰MAPEä½¿ç”¨maskï¼ˆä¸ºäº†é¿å…é™¤0é”™è¯¯ï¼‰
- æ²¡æœ‰maskå½’ä¸€åŒ–

#### âŒ é—®é¢˜è¯Šæ–­

è¿™æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„ä¸å…¬å¹³æ¯”è¾ƒé—®é¢˜**ï¼š

1. **STAEformerçš„masked metricsä¼šäº§ç”Ÿåä½çš„è¯¯å·®å€¼**ï¼š
   - å¦‚æœæ•°æ®ä¸­æœ‰ä»»ä½•0å€¼ï¼ˆä¾‹å¦‚å¤œé—´äº¤é€šæµé‡å¯èƒ½æ¥è¿‘0ï¼‰
   - STAEformerä¼šå®Œå…¨å¿½ç•¥è¿™äº›ç‚¹çš„é¢„æµ‹è¯¯å·®
   - è¿™ç›¸å½“äº"æŒ‘é€‰"æ›´å®¹æ˜“é¢„æµ‹çš„ç‚¹æ¥è®¡ç®—è¯¯å·®

2. **STGCNè®¡ç®—æ‰€æœ‰ç‚¹çš„è¯¯å·®ï¼ŒåŒ…æ‹¬éš¾é¢„æµ‹çš„ä½æµé‡æ—¶æ®µ**
   - è¿™å¯¼è‡´å…¶MAE/RMSEå€¼åé«˜

3. **maskå½’ä¸€åŒ–çš„å½±å“**ï¼š
   - `mask /= np.mean(mask)` ä¼šæ”¾å¤§å‰©ä½™ç‚¹çš„æƒé‡
   - è¿™è¿›ä¸€æ­¥æ‰­æ›²äº†è¯¯å·®è®¡ç®—

**å½±å“è¯„ä¼°**: è¿™ä¸ªé—®é¢˜å¯èƒ½è§£é‡Šäº†STAEformeråœ¨æ‰€æœ‰å®éªŒä¸­éƒ½æ˜¾è‘—ä¼˜äºSTGCNçš„åŸå› ã€‚

---

### 2. âš ï¸ è®­ç»ƒæ—¶çš„åå½’ä¸€åŒ–å·®å¼‚

#### STAEformer

```python
# train_3step.py: lines 87-90
out_batch = model(x_batch)
out_batch = SCALER.inverse_transform(out_batch)  # è®­ç»ƒæ—¶å°±åå½’ä¸€åŒ–ï¼
loss = criterion(out_batch, y_batch)  # åœ¨åŸå§‹å°ºåº¦ä¸Šè®¡ç®—æŸå¤±
```

**ç‰¹ç‚¹**ï¼š
- åœ¨**è®­ç»ƒã€éªŒè¯ã€æµ‹è¯•æ—¶éƒ½åœ¨åå½’ä¸€åŒ–åè®¡ç®—æŸå¤±**
- y_batchå·²ç»æ˜¯åŸå§‹å°ºåº¦ï¼ˆæœªå½’ä¸€åŒ–ï¼‰
- æŸå¤±åœ¨åŸå§‹æ•°å€¼å°ºåº¦ä¸Šè®¡ç®—

#### STGCN

```python
# train_pems04_3step.py: lines 93-94
out = net(A_wave, X_batch)  # è¾“å‡ºæ˜¯å½’ä¸€åŒ–çš„
loss = loss_criterion(out, y_batch)  # y_batchä¹Ÿæ˜¯å½’ä¸€åŒ–çš„
```

**ç‰¹ç‚¹**ï¼š
- è®­ç»ƒæ—¶åœ¨**å½’ä¸€åŒ–ç©ºé—´**è®¡ç®—æŸå¤±
- åªåœ¨æœ€ç»ˆæµ‹è¯•æ—¶åå½’ä¸€åŒ–

#### âš ï¸ é—®é¢˜è¯Šæ–­

è¿™ä¸¤ç§æ–¹æ³•å„æœ‰ä¼˜åŠ£ï¼Œä½†**ä¸ä¸€è‡´**ï¼š

1. **STAEformeråœ¨åŸå§‹å°ºåº¦è®­ç»ƒ**ï¼š
   - ä¼˜ç‚¹ï¼šæŸå¤±å€¼æ›´ç›´è§‚ï¼Œæ¢¯åº¦å°ºåº¦ä¸å®é™…æ•°å€¼ç›¸å…³
   - ç¼ºç‚¹ï¼šå¯èƒ½å¯¼è‡´æ¢¯åº¦ä¸ç¨³å®šï¼ˆæ•°å€¼èŒƒå›´å¤§ï¼‰

2. **STGCNåœ¨å½’ä¸€åŒ–ç©ºé—´è®­ç»ƒ**ï¼š
   - ä¼˜ç‚¹ï¼šè®­ç»ƒæ›´ç¨³å®šï¼Œæ¢¯åº¦å°ºåº¦ä¸€è‡´
   - ç¼ºç‚¹ï¼šæŸå¤±å€¼ä¸ç›´è§‚

**å½±å“è¯„ä¼°**: è¿™ä¸ªå·®å¼‚ä¼šå½±å“è®­ç»ƒåŠ¨æ€ï¼Œä½†ä¸åº”è¯¥å¯¼è‡´å¦‚æ­¤å¤§çš„æ€§èƒ½å·®è·ã€‚

---

### 3. æŸå¤±å‡½æ•°å·®å¼‚

#### STAEformer

```python
# train_3step.py: lines 289-292
if dataset in ("PEMS03", "PEMS04", "PEMS07", "PEMS08"):
    criterion = nn.HuberLoss()  # å¯¹å¼‚å¸¸å€¼æ›´é²æ£’
elif dataset in ("METRLA", "PEMSBAY"):
    criterion = MaskedMAELoss()  # å¿½ç•¥0å€¼çš„MAEæŸå¤±
```

#### STGCN

```python
# train_pems04_3step.py: line 168
loss_criterion = nn.MSELoss()  # æ ‡å‡†MSEæŸå¤±
```

#### åˆ†æ

- **HuberLoss vs MSELoss**: HuberLosså¯¹å¼‚å¸¸å€¼æ›´é²æ£’ï¼Œå¯èƒ½å¸®åŠ©STAEformerè®­ç»ƒæ›´ç¨³å®š
- **MaskedMAELoss**: åœ¨METR-LAæ•°æ®é›†ä¸Šï¼ŒSTAEformerä½¿ç”¨masked lossï¼Œè¿™ä¸å…¶metricsä¸€è‡´
- è¿™ä¸ªå·®å¼‚æ˜¯åˆç†çš„è®¾è®¡é€‰æ‹©ï¼Œä½†å¯èƒ½å½±å“æœ€ç»ˆæ€§èƒ½

---

### 4. æ•°æ®é¢„å¤„ç†å¯¹æ¯”

#### STAEformer

```python
# lib/data_prepare.py: lines 43-47
scaler = StandardScaler(mean=x_train[..., 0].mean(), std=x_train[..., 0].std())
x_train[..., 0] = scaler.transform(x_train[..., 0])
x_val[..., 0] = scaler.transform(x_val[..., 0])
x_test[..., 0] = scaler.transform(x_test[..., 0])
```

#### STGCN

```python
# train_pems04_3step.py: lines 50-55
train_size = int(0.6 * X.shape[0])
train_data = X[:train_size]
mean = train_data.mean()
std = train_data.std()
X = (X - mean) / std
```

#### âœ… ç»“è®º

æ•°æ®é¢„å¤„ç†åŸºæœ¬ä¸€è‡´ï¼Œéƒ½ä½¿ç”¨è®­ç»ƒé›†çš„å‡å€¼å’Œæ ‡å‡†å·®è¿›è¡ŒZ-scoreå½’ä¸€åŒ–ã€‚

---

### 5. æ¨¡å‹æ¶æ„å·®å¼‚

#### STAEformer
- å¤æ‚çš„Transformeræ¶æ„ï¼ŒåŒ…å«æ—¶ç©ºæ³¨æ„åŠ›æœºåˆ¶
- å‚æ•°é‡ï¼šçº¦200-300Kï¼ˆå–å†³äºé…ç½®ï¼‰

#### STGCN
- ç®€å•çš„æ—¶ç©ºå›¾å·ç§¯ç½‘ç»œ
- å‚æ•°é‡ï¼šçº¦97K

#### åˆ†æ
STAEformeræ˜¯æ›´å¤æ‚çš„æ¨¡å‹ï¼Œç†è®ºä¸Šåº”è¯¥æœ‰æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ›ï¼Œä½†45-54%çš„æ€§èƒ½æå‡ï¼ˆMETR-LAï¼‰ä¼¼ä¹è¿‡å¤§ã€‚

---

## å…³é”®é—®é¢˜æ€»ç»“

### ğŸ”´ ä¸¥é‡é—®é¢˜

1. **Masked Metricsä¸ä¸€è‡´** (æœ€ä¸¥é‡)
   - STAEformerä½¿ç”¨masked metricså¿½ç•¥y=0çš„ç‚¹
   - STGCNä½¿ç”¨æ ‡å‡†metricsè®¡ç®—æ‰€æœ‰ç‚¹
   - **è¿™å¯¼è‡´å®Œå…¨ä¸å…¬å¹³çš„å¯¹æ¯”**

### ğŸŸ¡ æ¬¡è¦é—®é¢˜

2. **è®­ç»ƒå°ºåº¦ä¸ä¸€è‡´**
   - STAEformeråœ¨åŸå§‹å°ºåº¦è®­ç»ƒ
   - STGCNåœ¨å½’ä¸€åŒ–ç©ºé—´è®­ç»ƒ
   - å½±å“è®­ç»ƒåŠ¨æ€ï¼Œä½†ä¸åº”å¯¼è‡´å·¨å¤§æ€§èƒ½å·®è·

3. **æŸå¤±å‡½æ•°ä¸åŒ**
   - STAEformer: HuberLoss (PeMS) / MaskedMAELoss (METR-LA)
   - STGCN: MSELoss
   - åˆç†çš„è®¾è®¡å·®å¼‚ï¼Œä½†å½±å“å¯æ¯”æ€§

---

## å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ç»Ÿä¸€ä½¿ç”¨æ ‡å‡†Metricsï¼ˆæ¨èï¼‰

ä¿®æ”¹STAEformerçš„metrics.pyï¼Œä½¿ç”¨ä¸å¸¦maskçš„æ ‡å‡†è®¡ç®—ï¼š

```python
def MAE_standard(y_true, y_pred):
    """æ ‡å‡†MAEï¼Œä¸ä½¿ç”¨mask"""
    return np.mean(np.abs(y_pred - y_true))

def RMSE_standard(y_true, y_pred):
    """æ ‡å‡†RMSEï¼Œä¸ä½¿ç”¨mask"""
    return np.sqrt(np.mean((y_pred - y_true) ** 2))
```

é‡æ–°æµ‹è¯•STAEformerï¼Œä½¿ç”¨å…¬å¹³çš„metricsã€‚

### æ–¹æ¡ˆ2: éƒ½ä½¿ç”¨Masked Metrics

ä¿®æ”¹STGCNçš„æµ‹è¯•ä»£ç ï¼Œä½¿ç”¨ä¸STAEformerç›¸åŒçš„masked metricsã€‚ä½†è¿™å¯èƒ½éšè—ä½æµé‡æ—¶æ®µçš„é¢„æµ‹é—®é¢˜ã€‚

### æ–¹æ¡ˆ3: æŠ¥å‘Šä¸¤ç§Metrics

åŒæ—¶æŠ¥å‘Šmaskedå’Œunmaskedç»“æœï¼Œè®©è¯»è€…äº†è§£å®Œæ•´æƒ…å†µï¼š
- Masked metrics: å¿½ç•¥ä½æµé‡æ—¶æ®µ
- Standard metrics: åŒ…å«æ‰€æœ‰æ—¶æ®µ

---

## æ•°æ®é›†ç‰¹å¾åˆ†æå»ºè®®

å»ºè®®æ£€æŸ¥æ•°æ®é›†ä¸­0å€¼çš„æ¯”ä¾‹ï¼š

```python
# æ£€æŸ¥æ¯ä¸ªæ•°æ®é›†ä¸­0å€¼çš„æ¯”ä¾‹
data = np.load('data/PEMS04.npz')['data']
zero_ratio = np.mean(data == 0) * 100
print(f"PEMS04 zero ratio: {zero_ratio:.2f}%")
```

å¦‚æœ0å€¼æ¯”ä¾‹è¾ƒé«˜ï¼Œmasked metricsçš„å½±å“ä¼šæ›´å¤§ã€‚

---

## å®éªŒå¯é æ€§è¯„ä¼°

åŸºäºä»¥ä¸Šåˆ†æï¼š

| æ–¹é¢ | è¯„ä¼° | è¯´æ˜ |
|------|------|------|
| æ•°æ®é¢„å¤„ç† | âœ… å¯é  | ä¸¤ä¸ªæ¨¡å‹ä¸€è‡´ä½¿ç”¨è®­ç»ƒé›†ç»Ÿè®¡é‡ |
| è®­ç»ƒè®¾ç½® | ğŸŸ¡ åŸºæœ¬å¯é  | æŸå¤±å‡½æ•°ä¸åŒä½†åˆç† |
| **è¯„ä¼°æŒ‡æ ‡** | âŒ **ä¸å¯é ** | **Masked vs Standard metricså¯¼è‡´ä¸å…¬å¹³å¯¹æ¯”** |
| æ•´ä½“ç»“è®º | âš ï¸ éœ€è¦ä¿®æ­£ | å¿…é¡»ä½¿ç”¨ä¸€è‡´çš„metricsé‡æ–°è¯„ä¼° |

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³**ï¼šä¿®æ”¹ä»£ç ï¼Œä½¿ç”¨ä¸€è‡´çš„è¯„ä¼°æŒ‡æ ‡
2. é‡æ–°è¿è¡Œæ‰€æœ‰18ä¸ªå®éªŒçš„æµ‹è¯•
3. æ¯”è¾ƒmaskedå’Œstandard metricsçš„ç»“æœå·®å¼‚
4. åˆ†ææ•°æ®é›†ä¸­0å€¼çš„åˆ†å¸ƒ
5. æ›´æ–°å®éªŒç»“æœè¡¨æ ¼

åªæœ‰åœ¨ä½¿ç”¨å…¬å¹³çš„è¯„ä¼°æŒ‡æ ‡åï¼Œæ‰èƒ½å¾—å‡ºå¯é çš„æ¨¡å‹æ€§èƒ½å¯¹æ¯”ç»“è®ºã€‚
